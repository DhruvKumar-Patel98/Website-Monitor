{% extends 'monitoring/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'css/dashboard.css' %}"> <!-- Link to custom CSS -->

<h1>Dashboard</h1>
<p>Welcome to the Dashboard. Here you can monitor your website’s performance.</p>

<h2>Monitoring Checks</h2>

<!-- Card Container -->
<div class="card-container">
    {% for check in monitoring_checks %}
        <div class="card" onclick="openChart('{{ check.id }}')">
            <h3>{{ check.name_of_check }}</h3>
            {% with latest_result=check.monitoringresult_set.last %}
                {% if latest_result %}
                    <div class="status-indicator {% if latest_result.status == '200' %}status-up{% else %}status-down{% endif %}">
                        ● {{ latest_result.status }}
                    </div>
                    <p>Previous Check: {{ latest_result.checked_at|date:"Y-m-d H:i:s" }}</p>
                {% else %}
                    <div class="status-indicator status-unknown">
                        ● No checks yet
                    </div>
                    <p>Previous Check: N/A</p>
                {% endif %}
            {% endwith %}
        </div>
    {% endfor %}
</div>

<!-- Chart Container -->
<div id="chartContainer">
    <h2>Response Time Chart</h2>
    <canvas id="responseChart" width="400" height="200"></canvas>
</div>

<h2>Monitoring Results</h2>
<table>
    <thead>
        <tr>
            <th>URL</th>
            <th>Status</th>
            <th>Response Time (ms)</th>
            <th>Checked At</th>
        </tr>
    </thead>
    <tbody>
        {% for result in results %}
        <tr>
            <td>{{ result.url }}</td>
            <td>{{ result.status }}</td>
            <td>{{ result.response_time }}</td>
            <td>{{ result.checked_at }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let myChart; // Declare myChart variable globally

    // Load initial chart data for the first monitoring check
    document.addEventListener('DOMContentLoaded', () => {
        const initialCheckId = '{{ monitoring_checks.first.id }}'; // Get the ID of the first check
        openChart(initialCheckId);
    });

    function openChart(checkId) {
        fetch(`/api/chart-data/${checkId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const labels = data.labels.slice(-10);
                const datas = data.data.slice(-10);
                // Check if data.labels and data.data are arrays
                if (Array.isArray(labels) && Array.isArray(datas)) {
                    
                    const chartData = {
                        labels: labels,
                        datasets: [{
                            label: 'Response Time',
                            data: datas,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            fill: false // Set to true if you want the area below the line to be filled
                        }]
                    };

                    createChart(chartData);
                } else {
                    console.error('Invalid data format:', data);
                    alert('Error: Invalid data format received.');
                }
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
                alert('Error fetching chart data. Please try again later.');
            });
    }

    function createChart(chartData) {
        const ctx = document.getElementById('responseChart').getContext('2d');

        // Destroy existing chart if it exists
        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Response Time (ms)' // Y-axis title
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Previous Checked' // X-axis title
                        },
                        ticks: {
                            display: false // Disable x-axis labels
                        },
                    }
                }
            }
        });
    }
</script>

{% endblock %}
